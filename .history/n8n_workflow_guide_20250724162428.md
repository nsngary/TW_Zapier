# 🔧 n8n 台灣電商 Demo 工作流建立指南

## 📋 **前置準備**

1. **確認服務運行**：
   - n8n: http://localhost:5678 ✅
   - FastAPI: http://localhost:8000 ✅
   - PostgreSQL: localhost:5432 ✅
   - Redis: localhost:6379 ✅

2. **登入 n8n**：
   - 開啟瀏覽器前往 http://localhost:5678
   - 使用帳號密碼登入

## 🚀 **建立工作流步驟**

### **步驟 1：建立新工作流**
1. 點擊 "New Workflow" 或 "+" 按鈕
2. 工作流名稱：`台灣電商訂單處理 Demo`

### **步驟 2：添加 Webhook 觸發器**
1. 點擊 "Add first step"
2. 搜尋並選擇 "Webhook"
3. 設定參數：
   - **HTTP Method**: POST
   - **Path**: `taiwan-order-demo`
   - **Response Mode**: Using 'Respond to Webhook' Node
   - **Authentication**: None

### **步驟 3：添加資料處理節點**
1. 點擊 Webhook 節點右側的 "+" 
2. 搜尋並選擇 "Set"
3. 節點名稱：`處理訂單資料`
4. 設定 Values：
   ```
   customer_name: {{ $json.customer_name || '測試客戶' }}
   total_amount: {{ $json.total_amount || 50000 }}
   payment_method: {{ $json.total_amount > 100000 ? 'ecPay' : 'linePay' }}
   order_timestamp: {{ new Date().toISOString() }}
   ```

### **步驟 4：添加 HTTP 請求節點（訂單處理）**
1. 點擊 Set 節點右側的 "+"
2. 搜尋並選擇 "HTTP Request"
3. 節點名稱：`呼叫訂單 API`
4. 設定參數：
   - **Method**: POST
   - **URL**: `http://host.docker.internal:8000/api/v1/demo/orders`
   - **Send Headers**: 啟用
     - Name: `Content-Type`
     - Value: `application/json`
   - **Send Body**: 啟用
   - **Body Content Type**: JSON
   - **JSON**: 
     ```json
     {
       "customer_name": "{{ $json.customer_name }}",
       "customer_email": "demo@example.com",
       "customer_phone": "0912345678",
       "total_amount": {{ $json.total_amount }},
       "payment_method": "{{ $json.payment_method }}",
       "items": [
         {
           "product_id": "DEMO001",
           "product_name": "示範商品",
           "quantity": 1,
           "unit_price": {{ $json.total_amount }},
           "subtotal": {{ $json.total_amount }}
         }
       ]
     }
     ```

### **步驟 5：添加通知節點**
1. 點擊 HTTP Request 節點右側的 "+"
2. 搜尋並選擇 "HTTP Request"
3. 節點名稱：`發送通知`
4. 設定參數：
   - **Method**: POST
   - **URL**: `http://host.docker.internal:8000/api/v1/demo/notifications`
   - **Send Headers**: 啟用
     - Name: `Content-Type`
     - Value: `application/json`
   - **Send Body**: 啟用
   - **Body Content Type**: JSON
   - **JSON**:
     ```json
     {
       "message": "訂單 {{ $json.order_id }} 已建立，客戶：{{ $json.customer_name }}，金額：NT${{ Math.round($json.total_amount / 100) }}，付款方式：{{ $json.payment_method }}",
       "recipient": "店家管理員",
       "notification_type": "order_created"
     }
     ```

### **步驟 6：添加回應節點**
1. 點擊通知節點右側的 "+"
2. 搜尋並選擇 "Respond to Webhook"
3. 節點名稱：`回傳結果`
4. 設定參數：
   - **Respond With**: JSON
   - **Response Body**:
     ```json
     {
       "success": true,
       "message": "台灣電商訂單處理完成",
       "order_id": "{{ $json.order_id }}",
       "customer_name": "{{ $json.customer_name }}",
       "payment_method": "{{ $json.payment_method }}",
       "notification_sent": true,
       "processed_at": "{{ new Date().toISOString() }}"
     }
     ```

### **步驟 7：啟用工作流**
1. 點擊右上角的 "Inactive" 開關，變成 "Active"
2. 點擊 "Save" 儲存工作流
3. 記下 Webhook URL（通常是 `http://localhost:5678/webhook/taiwan-order-demo`）

## 🧪 **測試工作流**

### **測試命令**
```bash
curl -X POST http://localhost:5678/webhook/taiwan-order-demo \
  -H "Content-Type: application/json" \
  -d '{
    "customer_name": "王小明",
    "customer_email": "wang@example.com",
    "customer_phone": "0912345678",
    "total_amount": 50000,
    "items": [
      {
        "product_id": "TEST001",
        "product_name": "測試商品",
        "quantity": 1,
        "unit_price": 50000,
        "subtotal": 50000
      }
    ]
  }'
```

### **預期回應**
```json
{
  "success": true,
  "message": "台灣電商訂單處理完成",
  "order_id": "TW20250724XXXXXXXX",
  "customer_name": "王小明",
  "payment_method": "linePay",
  "notification_sent": true,
  "processed_at": "2025-07-24T16:30:00.000Z"
}
```

## 🎯 **驗證重點**

### **台灣在地化功能**
- ✅ **金額判斷**: 小額使用 Line Pay，高額使用綠界科技
- ✅ **台灣時區**: Asia/Taipei
- ✅ **繁體中文**: 訊息和回應都使用繁體中文
- ✅ **台灣金流**: 支援 Line Pay、綠界科技、藍新金流

### **工作流功能**
- ✅ **Webhook 觸發**: 接收 HTTP POST 請求
- ✅ **資料處理**: 驗證和轉換訂單資料
- ✅ **API 整合**: 呼叫 FastAPI 後端服務
- ✅ **通知系統**: 發送訂單確認通知
- ✅ **回應處理**: 回傳結構化的 JSON 回應

## 🔧 **故障排除**

### **常見問題**
1. **Webhook 無法觸發**：
   - 檢查工作流是否已啟用（Active）
   - 確認 URL 路徑正確

2. **API 呼叫失敗**：
   - 確認 FastAPI 服務正在運行
   - 檢查 URL 是否使用 `host.docker.internal`

3. **資料格式錯誤**：
   - 檢查 JSON 格式是否正確
   - 確認變數引用語法 `{{ $json.field_name }}`

### **除錯技巧**
- 使用 n8n 的 "Execute Workflow" 功能測試
- 檢查每個節點的輸出資料
- 查看 n8n 的執行日誌

## 📊 **成功指標**

當您完成工作流建立後，應該能夠：
1. ✅ 成功觸發 Webhook
2. ✅ 處理不同金額的訂單
3. ✅ 自動選擇適當的台灣金流服務
4. ✅ 發送通知訊息
5. ✅ 回傳完整的處理結果

完成後，請執行測試命令驗證功能！
